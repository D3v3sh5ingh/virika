FSS={FRONT:0,BACK:1,DOUBLE:2,SVGNS:"http://www.w3.org/2000/svg"},FSS.Array="function"==typeof Float32Array?Float32Array:Array,FSS.Utils={isNumber:function(value){return!isNaN(parseFloat(value))&&isFinite(value)}},function(){for(var lastTime=0,vendors=["ms","moz","webkit","o"],x=0;x<vendors.length&&!window.requestAnimationFrame;++x)window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(callback,element){var currentTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currentTime-lastTime)),id=window.setTimeout((function(){callback(currentTime+timeToCall)}),timeToCall);return lastTime=currentTime+timeToCall,id}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(id){clearTimeout(id)})}(),Math.PIM2=2*Math.PI,Math.PID2=Math.PI/2,Math.randomInRange=function(min,max){return min+(max-min)*Math.random()},Math.clamp=function(value,min,max){return value=Math.max(value,min),value=Math.min(value,max)},FSS.Vector3={create:function(x,y,z){var vector=new FSS.Array(3);return this.set(vector,x,y,z),vector},clone:function(a){var vector=this.create();return this.copy(vector,a),vector},set:function(target,x,y,z){return target[0]=x||0,target[1]=y||0,target[2]=z||0,this},setX:function(target,x){return target[0]=x||0,this},setY:function(target,y){return target[1]=y||0,this},setZ:function(target,z){return target[2]=z||0,this},copy:function(target,a){return target[0]=a[0],target[1]=a[1],target[2]=a[2],this},add:function(target,a){return target[0]+=a[0],target[1]+=a[1],target[2]+=a[2],this},addVectors:function(target,a,b){return target[0]=a[0]+b[0],target[1]=a[1]+b[1],target[2]=a[2]+b[2],this},addScalar:function(target,s){return target[0]+=s,target[1]+=s,target[2]+=s,this},subtract:function(target,a){return target[0]-=a[0],target[1]-=a[1],target[2]-=a[2],this},subtractVectors:function(target,a,b){return target[0]=a[0]-b[0],target[1]=a[1]-b[1],target[2]=a[2]-b[2],this},subtractScalar:function(target,s){return target[0]-=s,target[1]-=s,target[2]-=s,this},multiply:function(target,a){return target[0]*=a[0],target[1]*=a[1],target[2]*=a[2],this},multiplyVectors:function(target,a,b){return target[0]=a[0]*b[0],target[1]=a[1]*b[1],target[2]=a[2]*b[2],this},multiplyScalar:function(target,s){return target[0]*=s,target[1]*=s,target[2]*=s,this},divide:function(target,a){return target[0]/=a[0],target[1]/=a[1],target[2]/=a[2],this},divideVectors:function(target,a,b){return target[0]=a[0]/b[0],target[1]=a[1]/b[1],target[2]=a[2]/b[2],this},divideScalar:function(target,s){return 0!==s?(target[0]/=s,target[1]/=s,target[2]/=s):(target[0]=0,target[1]=0,target[2]=0),this},cross:function(target,a){var x=target[0],y=target[1],z=target[2];return target[0]=y*a[2]-z*a[1],target[1]=z*a[0]-x*a[2],target[2]=x*a[1]-y*a[0],this},crossVectors:function(target,a,b){return target[0]=a[1]*b[2]-a[2]*b[1],target[1]=a[2]*b[0]-a[0]*b[2],target[2]=a[0]*b[1]-a[1]*b[0],this},min:function(target,value){return target[0]<value&&(target[0]=value),target[1]<value&&(target[1]=value),target[2]<value&&(target[2]=value),this},max:function(target,value){return target[0]>value&&(target[0]=value),target[1]>value&&(target[1]=value),target[2]>value&&(target[2]=value),this},clamp:function(target,min,max){return this.min(target,min),this.max(target,max),this},limit:function(target,min,max){var length=this.length(target);return null!==min&&length<min?this.setLength(target,min):null!==max&&length>max&&this.setLength(target,max),this},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},normalise:function(target){return this.divideScalar(target,this.length(target))},negate:function(target){return this.multiplyScalar(target,-1)},distanceSquared:function(a,b){var dx=a[0]-b[0],dy=a[1]-b[1],dz=a[2]-b[2];return dx*dx+dy*dy+dz*dz},distance:function(a,b){return Math.sqrt(this.distanceSquared(a,b))},lengthSquared:function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},length:function(a){return Math.sqrt(this.lengthSquared(a))},setLength:function(target,l){var length=this.length(target);return 0!==length&&l!==length&&this.multiplyScalar(target,l/length),this}},FSS.Vector4={create:function(x,y,z,w){var vector=new FSS.Array(4);return this.set(vector,x,y,z),vector},set:function(target,x,y,z,w){return target[0]=x||0,target[1]=y||0,target[2]=z||0,target[3]=w||0,this},setX:function(target,x){return target[0]=x||0,this},setY:function(target,y){return target[1]=y||0,this},setZ:function(target,z){return target[2]=z||0,this},setW:function(target,w){return target[3]=w||0,this},add:function(target,a){return target[0]+=a[0],target[1]+=a[1],target[2]+=a[2],target[3]+=a[3],this},multiplyVectors:function(target,a,b){return target[0]=a[0]*b[0],target[1]=a[1]*b[1],target[2]=a[2]*b[2],target[3]=a[3]*b[3],this},multiplyScalar:function(target,s){return target[0]*=s,target[1]*=s,target[2]*=s,target[3]*=s,this},min:function(target,value){return target[0]<value&&(target[0]=value),target[1]<value&&(target[1]=value),target[2]<value&&(target[2]=value),target[3]<value&&(target[3]=value),this},max:function(target,value){return target[0]>value&&(target[0]=value),target[1]>value&&(target[1]=value),target[2]>value&&(target[2]=value),target[3]>value&&(target[3]=value),this},clamp:function(target,min,max){return this.min(target,min),this.max(target,max),this}},FSS.Color=function(hex,opacity){this.rgba=FSS.Vector4.create(),this.hex=hex||"#333",this.opacity=FSS.Utils.isNumber(opacity)?opacity:1,this.set(this.hex,this.opacity)},FSS.Color.prototype={set:function(hex,opacity){var size=(hex=hex.replace("#","")).length/3;return this.rgba[0]=parseInt(hex.substring(0*size,1*size),16)/255,this.rgba[1]=parseInt(hex.substring(1*size,2*size),16)/255,this.rgba[2]=parseInt(hex.substring(2*size,3*size),16)/255,this.rgba[3]=FSS.Utils.isNumber(opacity)?opacity:this.rgba[3],this},hexify:function(channel){var hex=Math.ceil(255*channel).toString(16);return 1===hex.length&&(hex="0"+hex),hex},format:function(){var r=this.hexify(this.rgba[0]),g=this.hexify(this.rgba[1]),b=this.hexify(this.rgba[2]);return this.hex="#"+r+g+b,this.hex}},FSS.Object=function(){this.position=FSS.Vector3.create()},FSS.Object.prototype={setPosition:function(x,y,z){return FSS.Vector3.set(this.position,x,y,z),this}},FSS.Light=function(ambient,diffuse){FSS.Object.call(this),this.ambient=new FSS.Color(ambient||"#FFFFFF"),this.diffuse=new FSS.Color(diffuse||"#FFFFFF"),this.ray=FSS.Vector3.create()},FSS.Light.prototype=Object.create(FSS.Object.prototype),FSS.Vertex=function(x,y,z){this.position=FSS.Vector3.create(x,y,z)},FSS.Vertex.prototype={setPosition:function(x,y,z){return FSS.Vector3.set(this.position,x,y,z),this}},FSS.Triangle=function(a,b,c){this.a=a||new FSS.Vertex,this.b=b||new FSS.Vertex,this.c=c||new FSS.Vertex,this.vertices=[this.a,this.b,this.c],this.u=FSS.Vector3.create(),this.v=FSS.Vector3.create(),this.centroid=FSS.Vector3.create(),this.normal=FSS.Vector3.create(),this.color=new FSS.Color,this.polygon=document.createElementNS(FSS.SVGNS,"polygon"),this.polygon.setAttributeNS(null,"stroke-linejoin","round"),this.polygon.setAttributeNS(null,"stroke-miterlimit","1"),this.polygon.setAttributeNS(null,"stroke-width","1"),this.computeCentroid(),this.computeNormal()},FSS.Triangle.prototype={computeCentroid:function(){return this.centroid[0]=this.a.position[0]+this.b.position[0]+this.c.position[0],this.centroid[1]=this.a.position[1]+this.b.position[1]+this.c.position[1],this.centroid[2]=this.a.position[2]+this.b.position[2]+this.c.position[2],FSS.Vector3.divideScalar(this.centroid,3),this},computeNormal:function(){return FSS.Vector3.subtractVectors(this.u,this.b.position,this.a.position),FSS.Vector3.subtractVectors(this.v,this.c.position,this.a.position),FSS.Vector3.crossVectors(this.normal,this.u,this.v),FSS.Vector3.normalise(this.normal),this}},FSS.Geometry=function(){this.vertices=[],this.triangles=[],this.dirty=!1},FSS.Geometry.prototype={update:function(){if(this.dirty){var t,triangle;for(t=this.triangles.length-1;t>=0;t--)(triangle=this.triangles[t]).computeCentroid(),triangle.computeNormal();this.dirty=!1}return this}},FSS.Plane=function(width,height,segments,slices){FSS.Geometry.call(this),this.width=width||100,this.height=height||100,this.segments=segments||4,this.slices=slices||4,this.segmentWidth=this.width/this.segments,this.sliceHeight=this.height/this.slices;var x,y,v0,v1,v2,v3,vertex,triangle,vertices=[],offsetX=-.5*this.width,offsetY=.5*this.height;for(x=0;x<=this.segments;x++)for(vertices.push([]),y=0;y<=this.slices;y++)vertex=new FSS.Vertex(offsetX+x*this.segmentWidth,offsetY-y*this.sliceHeight),vertices[x].push(vertex),this.vertices.push(vertex);for(x=0;x<this.segments;x++)for(y=0;y<this.slices;y++)v0=vertices[x+0][y+0],v1=vertices[x+0][y+1],v2=vertices[x+1][y+0],v3=vertices[x+1][y+1],t0=new FSS.Triangle(v0,v1,v2),t1=new FSS.Triangle(v2,v1,v3),this.triangles.push(t0,t1)},FSS.Plane.prototype=Object.create(FSS.Geometry.prototype),FSS.Material=function(ambient,diffuse){this.ambient=new FSS.Color(ambient||"#f20000"),this.diffuse=new FSS.Color(diffuse||"#f20000"),this.slave=new FSS.Color},FSS.Mesh=function(geometry,material){FSS.Object.call(this),this.geometry=geometry||new FSS.Geometry,this.material=material||new FSS.Material,this.side=FSS.FRONT,this.visible=!0},FSS.Mesh.prototype=Object.create(FSS.Object.prototype),FSS.Mesh.prototype.update=function(lights,calculate){var t,triangle,l,light,illuminance;if(this.geometry.update(),calculate)for(t=this.geometry.triangles.length-1;t>=0;t--){for(triangle=this.geometry.triangles[t],FSS.Vector4.set(triangle.color.rgba),l=lights.length-1;l>=0;l--)light=lights[l],FSS.Vector3.subtractVectors(light.ray,light.position,triangle.centroid),FSS.Vector3.normalise(light.ray),illuminance=FSS.Vector3.dot(triangle.normal,light.ray),this.side===FSS.FRONT?illuminance=Math.max(illuminance,0):this.side===FSS.BACK?illuminance=Math.abs(Math.min(illuminance,0)):this.side===FSS.DOUBLE&&(illuminance=Math.max(Math.abs(illuminance),0)),FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.ambient.rgba,light.ambient.rgba),FSS.Vector4.add(triangle.color.rgba,this.material.slave.rgba),FSS.Vector4.multiplyVectors(this.material.slave.rgba,this.material.diffuse.rgba,light.diffuse.rgba),FSS.Vector4.multiplyScalar(this.material.slave.rgba,illuminance),FSS.Vector4.add(triangle.color.rgba,this.material.slave.rgba);FSS.Vector4.clamp(triangle.color.rgba,0,1)}return this},FSS.Scene=function(){this.meshes=[],this.lights=[]},FSS.Scene.prototype={add:function(object){return object instanceof FSS.Mesh&&!~this.meshes.indexOf(object)?this.meshes.push(object):object instanceof FSS.Light&&!~this.lights.indexOf(object)&&this.lights.push(object),this},remove:function(object){return object instanceof FSS.Mesh&&~this.meshes.indexOf(object)?this.meshes.splice(this.meshes.indexOf(object),1):object instanceof FSS.Light&&~this.lights.indexOf(object)&&this.lights.splice(this.lights.indexOf(object),1),this}},FSS.Renderer=function(){this.width=0,this.height=0,this.halfWidth=0,this.halfHeight=0},FSS.Renderer.prototype={setSize:function(width,height){if(this.width!==width||this.height!==height)return this.width=width,this.height=height,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this},clear:function(){return this},render:function(scene){return this}},FSS.CanvasRenderer=function(){FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.display="block",this.element.setAttribute("id","myCanvas"),this.context=this.element.getContext("2d"),this.setSize(this.element.width,this.element.height)},FSS.CanvasRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.CanvasRenderer.prototype.setSize=function(width,height){return FSS.Renderer.prototype.setSize.call(this,width,height),this.element.width=width,this.element.height=height,this.context.setTransform(1,0,0,-1,this.halfWidth,this.halfHeight),this},FSS.CanvasRenderer.prototype.clear=function(){return FSS.Renderer.prototype.clear.call(this),this.context.clearRect(-this.halfWidth,-this.halfHeight,this.width,this.height),this},FSS.CanvasRenderer.prototype.render=function(scene){var m,mesh,t,triangle,color;for(FSS.Renderer.prototype.render.call(this,scene),this.clear(),this.context.lineJoin="round",this.context.lineWidth=1,m=scene.meshes.length-1;m>=0;m--)if((mesh=scene.meshes[m]).visible)for(mesh.update(scene.lights,!0),t=mesh.geometry.triangles.length-1;t>=0;t--)color=(triangle=mesh.geometry.triangles[t]).color.format(),this.context.beginPath(),this.context.moveTo(triangle.a.position[0],triangle.a.position[1]),this.context.lineTo(triangle.b.position[0],triangle.b.position[1]),this.context.lineTo(triangle.c.position[0],triangle.c.position[1]),this.context.closePath(),this.context.strokeStyle=color,this.context.fillStyle=color,this.context.stroke(),this.context.fill();return this},FSS.WebGLRenderer=function(){FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.display="block",this.vertices=null,this.lights=null;var parameters={preserveDrawingBuffer:!1,premultipliedAlpha:!0,antialias:!0,stencil:!0,alpha:!0};if(this.gl=this.getContext(this.element,parameters),this.unsupported=!this.gl,this.unsupported)return"WebGL is not supported by your browser.";this.gl.clearColor(0,0,0,0),this.gl.enable(this.gl.DEPTH_TEST),this.setSize(this.element.width,this.element.height)},FSS.WebGLRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.WebGLRenderer.prototype.getContext=function(canvas,parameters){var context=!1;try{if(!(context=canvas.getContext("experimental-webgl",parameters)))throw"Error creating WebGL context."}catch(error){console.error(error)}return context},FSS.WebGLRenderer.prototype.setSize=function(width,height){if(FSS.Renderer.prototype.setSize.call(this,width,height),!this.unsupported)return this.element.width=width,this.element.height=height,this.gl.viewport(0,0,width,height),this},FSS.WebGLRenderer.prototype.clear=function(){if(FSS.Renderer.prototype.clear.call(this),!this.unsupported)return this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this},FSS.WebGLRenderer.prototype.render=function(scene){if(FSS.Renderer.prototype.render.call(this,scene),!this.unsupported){var m,mesh,t,tl,triangle,l,light,attribute,uniform,buffer,data,location,update=!1,lights=scene.lights.length,index,v,vl,vetex,vertices=0;if(this.clear(),this.lights!==lights){if(this.lights=lights,!(this.lights>0))return;this.buildProgram(lights)}if(this.program){for(m=scene.meshes.length-1;m>=0;m--)(mesh=scene.meshes[m]).geometry.dirty&&(update=!0),mesh.update(scene.lights,!1),vertices+=3*mesh.geometry.triangles.length;if(update||this.vertices!==vertices)for(attribute in this.vertices=vertices,this.program.attributes){for((buffer=this.program.attributes[attribute]).data=new FSS.Array(vertices*buffer.size),index=0,m=scene.meshes.length-1;m>=0;m--)for(t=0,tl=(mesh=scene.meshes[m]).geometry.triangles.length;t<tl;t++)for(v=0,vl=(triangle=mesh.geometry.triangles[t]).vertices.length;v<vl;v++){switch(vertex=triangle.vertices[v],attribute){case"side":this.setBufferData(index,buffer,mesh.side);break;case"position":this.setBufferData(index,buffer,vertex.position);break;case"centroid":this.setBufferData(index,buffer,triangle.centroid);break;case"normal":this.setBufferData(index,buffer,triangle.normal);break;case"ambient":this.setBufferData(index,buffer,mesh.material.ambient.rgba);break;case"diffuse":this.setBufferData(index,buffer,mesh.material.diffuse.rgba)}index++}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,buffer.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,buffer.data,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(buffer.location),this.gl.vertexAttribPointer(buffer.location,buffer.size,this.gl.FLOAT,!1,0,0)}for(this.setBufferData(0,this.program.uniforms.resolution,[this.width,this.height,this.width]),l=lights-1;l>=0;l--)light=scene.lights[l],this.setBufferData(l,this.program.uniforms.lightPosition,light.position),this.setBufferData(l,this.program.uniforms.lightAmbient,light.ambient.rgba),this.setBufferData(l,this.program.uniforms.lightDiffuse,light.diffuse.rgba);for(uniform in this.program.uniforms)switch(location=(buffer=this.program.uniforms[uniform]).location,data=buffer.data,buffer.structure){case"3f":this.gl.uniform3f(location,data[0],data[1],data[2]);break;case"3fv":this.gl.uniform3fv(location,data);break;case"4fv":this.gl.uniform4fv(location,data)}}return this.gl.drawArrays(this.gl.TRIANGLES,0,this.vertices),this}},FSS.WebGLRenderer.prototype.setBufferData=function(index,buffer,value){if(FSS.Utils.isNumber(value))buffer.data[index*buffer.size]=value;else for(var i=value.length-1;i>=0;i--)buffer.data[index*buffer.size+i]=value[i]},FSS.WebGLRenderer.prototype.buildProgram=function(lights){if(!this.unsupported){var vs=FSS.WebGLRenderer.VS(lights),fs=FSS.WebGLRenderer.FS(lights),code=vs+fs;if(!this.program||this.program.code!==code){var program=this.gl.createProgram(),vertexShader=this.buildShader(this.gl.VERTEX_SHADER,vs),fragmentShader=this.buildShader(this.gl.FRAGMENT_SHADER,fs);if(this.gl.attachShader(program,vertexShader),this.gl.attachShader(program,fragmentShader),this.gl.linkProgram(program),!this.gl.getProgramParameter(program,this.gl.LINK_STATUS)){var error=this.gl.getError(),status=this.gl.getProgramParameter(program,this.gl.VALIDATE_STATUS);return console.error("Could not initialise shader.\nVALIDATE_STATUS: "+status+"\nERROR: "+error),null}return this.gl.deleteShader(fragmentShader),this.gl.deleteShader(vertexShader),program.code=code,program.attributes={side:this.buildBuffer(program,"attribute","aSide",1,"f"),position:this.buildBuffer(program,"attribute","aPosition",3,"v3"),centroid:this.buildBuffer(program,"attribute","aCentroid",3,"v3"),normal:this.buildBuffer(program,"attribute","aNormal",3,"v3"),ambient:this.buildBuffer(program,"attribute","aAmbient",4,"v4"),diffuse:this.buildBuffer(program,"attribute","aDiffuse",4,"v4")},program.uniforms={resolution:this.buildBuffer(program,"uniform","uResolution",3,"3f",1),lightPosition:this.buildBuffer(program,"uniform","uLightPosition",3,"3fv",lights),lightAmbient:this.buildBuffer(program,"uniform","uLightAmbient",4,"4fv",lights),lightDiffuse:this.buildBuffer(program,"uniform","uLightDiffuse",4,"4fv",lights)},this.program=program,this.gl.useProgram(this.program),program}}},FSS.WebGLRenderer.prototype.buildShader=function(type,source){if(!this.unsupported){var shader=this.gl.createShader(type);return this.gl.shaderSource(shader,source),this.gl.compileShader(shader),this.gl.getShaderParameter(shader,this.gl.COMPILE_STATUS)?shader:(console.error(this.gl.getShaderInfoLog(shader)),null)}},FSS.WebGLRenderer.prototype.buildBuffer=function(program,type,identifier,size,structure,count){var buffer={buffer:this.gl.createBuffer(),size:size,structure:structure,data:null};switch(type){case"attribute":buffer.location=this.gl.getAttribLocation(program,identifier);break;case"uniform":buffer.location=this.gl.getUniformLocation(program,identifier)}return count&&(buffer.data=new FSS.Array(count*size)),buffer},FSS.WebGLRenderer.VS=function(lights){var shader;return["precision mediump float;","#define LIGHTS "+lights,"attribute float aSide;","attribute vec3 aPosition;","attribute vec3 aCentroid;","attribute vec3 aNormal;","attribute vec4 aAmbient;","attribute vec4 aDiffuse;","uniform vec3 uResolution;","uniform vec3 uLightPosition[LIGHTS];","uniform vec4 uLightAmbient[LIGHTS];","uniform vec4 uLightDiffuse[LIGHTS];","varying vec4 vColor;","void main() {","vColor = vec4(0.0);","vec3 position = aPosition / uResolution * 2.0;","for (int i = 0; i < LIGHTS; i++) {","vec3 lightPosition = uLightPosition[i];","vec4 lightAmbient = uLightAmbient[i];","vec4 lightDiffuse = uLightDiffuse[i];","vec3 ray = normalize(lightPosition - aCentroid);","float illuminance = dot(aNormal, ray);","if (aSide == 0.0) {","illuminance = max(illuminance, 0.0);","} else if (aSide == 1.0) {","illuminance = abs(min(illuminance, 0.0));","} else if (aSide == 2.0) {","illuminance = max(abs(illuminance), 0.0);","}","vColor += aAmbient * lightAmbient;","vColor += aDiffuse * lightDiffuse * illuminance;","}","vColor = clamp(vColor, 0.0, 1.0);","gl_Position = vec4(position, 1.0);","}"].join("\n")},FSS.WebGLRenderer.FS=function(lights){var shader;return["precision mediump float;","varying vec4 vColor;","void main() {","gl_FragColor = vColor;","}"].join("\n")},FSS.SVGRenderer=function(){FSS.Renderer.call(this),this.element=document.createElementNS(FSS.SVGNS,"svg"),this.element.setAttribute("xmlns",FSS.SVGNS),this.element.setAttribute("version","1.1"),this.element.style.display="block",this.setSize(300,150)},FSS.SVGRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.SVGRenderer.prototype.setSize=function(width,height){return FSS.Renderer.prototype.setSize.call(this,width,height),this.element.setAttribute("width",width),this.element.setAttribute("height",height),this},FSS.SVGRenderer.prototype.clear=function(){FSS.Renderer.prototype.clear.call(this);for(var i=this.element.childNodes.length-1;i>=0;i--)this.element.removeChild(this.element.childNodes[i]);return this},FSS.SVGRenderer.prototype.render=function(scene){var m,mesh,t,triangle,points,style;for(FSS.Renderer.prototype.render.call(this,scene),m=scene.meshes.length-1;m>=0;m--)if((mesh=scene.meshes[m]).visible)for(mesh.update(scene.lights,!0),t=mesh.geometry.triangles.length-1;t>=0;t--)(triangle=mesh.geometry.triangles[t]).polygon.parentNode!==this.element&&this.element.appendChild(triangle.polygon),points=this.formatPoint(triangle.a)+" ",points+=this.formatPoint(triangle.b)+" ",points+=this.formatPoint(triangle.c),style=this.formatStyle(triangle.color.format()),triangle.polygon.setAttributeNS(null,"points",points),triangle.polygon.setAttributeNS(null,"style",style);return this},FSS.SVGRenderer.prototype.formatPoint=function(vertex){return this.halfWidth+vertex.position[0]+","+(this.halfHeight-vertex.position[1])},FSS.SVGRenderer.prototype.formatStyle=function(color){var style="fill:"+color+";";return style+="stroke:"+color+";"},function(){var MESH_width=1.8,MESH_height=1.8,MESH_depth=10,MESH_segments=36,MESH_slices=8,MESH_xRange=.8,MESH_yRange=.1,MESH_zRange=1,MESH_ambient="#5e9a8e",MESH_diffuse="#5e9a8e",MESH_speed=1e-4,LIGHT={count:2,xyScalar:1,zOffset:100,ambient:"#000000",diffuse:"#ffffff",speed:2e-4,gravity:500,dampening:.95,minLimit:10,maxLimit:null,minDistance:20,maxDistance:400,autopilot:!0,draw:!1,bounds:FSS.Vector3.create(),step:FSS.Vector3.create(Math.randomInRange(.2,1),Math.randomInRange(.2,1),Math.randomInRange(.2,1))},RENDER_renderer="canvas",now,start=Date.now(),center=FSS.Vector3.create(),attractor=FSS.Vector3.create(),container=document.getElementById("container"),output=document.getElementById("output"),renderer,scene,mesh,geometry,material,canvasRenderer,gui,autopilotController;function initialise(){createRenderer(),createScene(),createMesh(),createLights(),addEventListeners(),resize(container.offsetWidth,container.offsetHeight),animate()}function createRenderer(){canvasRenderer=new FSS.CanvasRenderer,setRenderer(RENDER_renderer)}function setRenderer(index){renderer&&output.removeChild(renderer.element),(renderer=canvasRenderer).setSize(container.offsetWidth,container.offsetHeight),output.appendChild(renderer.element)}function createScene(){scene=new FSS.Scene}function createMesh(){var v,vertex;for(scene.remove(mesh),renderer.clear(),geometry=new FSS.Plane(MESH_width*renderer.width,MESH_height*renderer.height,MESH_segments,MESH_slices),material=new FSS.Material(MESH_ambient,MESH_diffuse),mesh=new FSS.Mesh(geometry,material),scene.add(mesh),v=geometry.vertices.length-1;v>=0;v--)(vertex=geometry.vertices[v]).anchor=FSS.Vector3.clone(vertex.position),vertex.step=FSS.Vector3.create(Math.randomInRange(.2,1),Math.randomInRange(.2,1),Math.randomInRange(.2,1)),vertex.time=Math.randomInRange(0,Math.PIM2)}function createLights(){var l,light;for(l=scene.lights.length-1;l>=0;l--)light=scene.lights[l],scene.remove(light);for(renderer.clear(),l=0;l<LIGHT.count;l++)(light=new FSS.Light(LIGHT.ambient,LIGHT.diffuse)).ambientHex=light.ambient.format(),light.diffuseHex=light.diffuse.format(),scene.add(light),light.mass=Math.randomInRange(.5,1),light.velocity=FSS.Vector3.create(),light.acceleration=FSS.Vector3.create(),light.force=FSS.Vector3.create(),light.ring=document.createElementNS(FSS.SVGNS,"circle"),light.ring.setAttributeNS(null,"stroke",light.ambientHex),light.ring.setAttributeNS(null,"stroke-width","0.5"),light.ring.setAttributeNS(null,"fill","none"),light.ring.setAttributeNS(null,"r","10"),light.core=document.createElementNS(FSS.SVGNS,"circle"),light.core.setAttributeNS(null,"fill",light.diffuseHex),light.core.setAttributeNS(null,"r","4")}function resize(width,height){renderer.setSize(width,height),FSS.Vector3.set(center,renderer.halfWidth,renderer.halfHeight),createMesh()}function animate(){now=Date.now()-start,update(),render(),requestAnimationFrame(animate)}function update(){var ox,oy,oz,l,light,v,vertex,offset=MESH_depth/2;for(FSS.Vector3.copy(LIGHT.bounds,center),FSS.Vector3.multiplyScalar(LIGHT.bounds,LIGHT.xyScalar),FSS.Vector3.setZ(attractor,LIGHT.zOffset),LIGHT.autopilot&&(ox=Math.sin(LIGHT.step[0]*now*LIGHT.speed),oy=Math.cos(LIGHT.step[1]*now*LIGHT.speed),FSS.Vector3.set(attractor,LIGHT.bounds[0]*ox,LIGHT.bounds[1]*oy,LIGHT.zOffset)),l=scene.lights.length-1;l>=0;l--){light=scene.lights[l],FSS.Vector3.setZ(light.position,LIGHT.zOffset);var D=Math.clamp(FSS.Vector3.distanceSquared(light.position,attractor),LIGHT.minDistance,LIGHT.maxDistance),F=LIGHT.gravity*light.mass/D;FSS.Vector3.subtractVectors(light.force,attractor,light.position),FSS.Vector3.normalise(light.force),FSS.Vector3.multiplyScalar(light.force,F),FSS.Vector3.set(light.acceleration),FSS.Vector3.add(light.acceleration,light.force),FSS.Vector3.add(light.velocity,light.acceleration),FSS.Vector3.multiplyScalar(light.velocity,LIGHT.dampening),FSS.Vector3.limit(light.velocity,LIGHT.minLimit,LIGHT.maxLimit),FSS.Vector3.add(light.position,light.velocity)}for(v=geometry.vertices.length-1;v>=0;v--)vertex=geometry.vertices[v],ox=Math.sin(vertex.time+vertex.step[0]*now*MESH_speed),oy=Math.cos(vertex.time+vertex.step[1]*now*MESH_speed),oz=Math.sin(vertex.time+vertex.step[2]*now*MESH_speed),FSS.Vector3.set(vertex.position,MESH_xRange*geometry.segmentWidth*ox,MESH_yRange*geometry.sliceHeight*oy,MESH_zRange*offset*oz-offset),FSS.Vector3.add(vertex.position,vertex.anchor);geometry.dirty=!0}function render(){var l,lx,ly,light;if(renderer.render(scene),LIGHT.draw)for(l=scene.lights.length-1;l>=0;l--)lx=(light=scene.lights[l]).position[0],ly=light.position[1],renderer.context.lineWidth=.5,renderer.context.beginPath(),renderer.context.arc(lx,ly,10,0,Math.PIM2),renderer.context.strokeStyle=light.ambientHex,renderer.context.stroke(),renderer.context.beginPath(),renderer.context.arc(lx,ly,4,0,Math.PIM2),renderer.context.fillStyle=light.diffuseHex,renderer.context.fill()}function addEventListeners(){window.addEventListener("resize",onWindowResize)}function onMouseMove(event){FSS.Vector3.set(attractor,event.x,renderer.height-event.y),FSS.Vector3.subtract(attractor,center)}function onWindowResize(event){resize(container.offsetWidth,container.offsetHeight),render()}initialise()}();